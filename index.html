<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>祥興台灣茶系列訂購表單</title>
  <meta name="color-scheme" content="light" />
  <meta name="theme-color" content="#ffffff" />
  <!-- 建議用基準版，縮放鎖定交給 app.js 動態處理 -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <meta name="gas-exec" content="https://script.google.com/macros/s/AKfycbwc09A_Sj_kxrZZYn1y0QXgNbTVuQ0159ok6zUrg6u9xOEenrBFUXVwoxVJB_Zs6qANlA/exec">

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4QY9T0ZJS3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-4QY9T0ZJS3', {
      send_page_view: true,
      debug_mode: location.search.includes('ga_debug=1')
    });
  </script>

  <!-- Leaflet（OSM，免金鑰）— 建議不要 defer，確保先於 app.js 載入 -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- 外部樣式 -->
  <link rel="stylesheet" href="/assets/css/style.css">

  <!-- 純靜態版本：讀取 URL promo 並廣播事件 -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const qs = new URLSearchParams(location.search || '');
    const promo = String(qs.get('promoCode') || qs.get('promo') || '').trim().toUpperCase();
    if (!promo) return;
    const input = document.querySelector('#promoCode');
    if (input) {
      input.value = promo;
      input.dispatchEvent(new Event('input', { bubbles: true }));
    }
    window.dispatchEvent(new CustomEvent('promo:applied', { detail: { promo } }));
  });
  </script>
</head>

<body>
<!-- ✅ Loading & Rotate 提示 -->
<div id="loading" role="status" aria-live="polite">送出中…請稍候</div>
<div class="rotate-hint" id="rotateHint">建議以直式瀏覽，獲得更好的體驗 🙌</div>

<!-- ✅ iOS-style Large Title Header -->
<header class="ios-header">
  <div class="ios-nav">
    <div class="ios-status"></div>
    <h1 class="ios-title-lg">祥興台灣茶系列訂購表單</h1>
    <div class="ios-subtitle">
      超商未滿 1000 運費 60；貨到付款未滿 2000 運費 100；達標免運
    </div>
  </div>
</header>

<!-- ✅ Step 1: 商品步驟 -->
<div class="card stepcard" id="itemsCard">
  <h2>選購商品</h2>
  <div id="categoryList" class="itemlist"></div>
</div>

<!-- ✅ Step 2: 收件資料 -->
<div class="section">
  <h2 class="section-title">收件資料</h2>

  <div class="form-group">
    <label for="phone">聯絡電話</label>
    <div id="err-phone" class="error-msg">請輸入有效電話</div>
    <input id="phone" type="tel" placeholder="09xxxxxxxx 或 0x-xxxxxxx">
    <span class="muted">輸入後將自動查找會員資料</span>
  </div>

  <div class="form-group">
    <label for="name">收件姓名</label>
    <div id="err-name" class="error-msg">請輸入姓名</div>
    <input id="name" type="text" placeholder="王小明">
  </div>

  <div class="form-group">
    <label for="promo">優惠碼</label>
    <div class="promo-row">
      <input id="promoCode" type="text" placeholder="請輸入優惠碼">
      <button id="applyPromo">套用</button>
    </div>
  </div>

  <div class="form-group">
    <label for="note">備註（選填）</label>
    <textarea id="note" placeholder="例如：有任何需求請註明（禮盒需求、延後出貨等）"></textarea>
  </div>
</div> <!-- ✅ 收件資料 section 結束 -->

<!-- ✅ Step 3: 運送方式 -->
<div class="section" id="shippingCard">
  <h2 class="section-title">運送方式</h2>

  <div class="ship-options">
    <label class="ship-radio">
      <input type="radio" name="ship" value="store" checked>
      <span>超商店到店（取貨付款）</span>
    </label>

    <label class="ship-radio">
      <input type="radio" name="ship" value="cod">
      <span>宅配（貨到付款）</span>
    </label>
  </div>

  <!-- ✅ 超商店到店 -->
  <div id="storeFields">
    <label>選擇超商</label>
    <div class="store-form">
      <div class="store-row">
        <select id="carrier" class="sp-select">
          <option value="7-11">7-ELEVEN</option>
          <option value="familymart">全家 FamilyMart</option>
        </select>

        <button id="openStorePicker" class="sp-search-title">附近門市 ▾</button>
      </div>

      <label for="storeName" class="sp-label">門市店名</label>
      <input id="storeName" type="text" class="sp-input" placeholder="輸入附近門市名稱或地標…" />
      <div id="err-store" class="error-msg">請選擇門市或輸入店名</div>

      <div id="storeResults" class="store-results"></div>
    </div>
  </div> <!-- ✅ 超商結束 -->

  <!-- ✅ 宅配到府 -->
  <div id="codFields" class="delivery-form" style="display:none;">
    <label class="sp-label">縣市</label>
    <select id="city" class="sp-select">
      <option value="">請選擇縣市</option>
    </select>

    <label class="sp-label">行政區</label>
    <select id="district" class="sp-select">
      <option value="">請選擇行政區</option>
    </select>

    <label class="sp-label">詳細地址</label>
    <input id="address" type="text" class="sp-input" placeholder="請填入路段、巷弄、門牌…" />
    <div id="err-address" class="error-msg">請填寫完整宅配地址</div>
  </div> <!-- ✅ 宅配結束 -->
</div> <!-- ✅ shippingCard 結束 -->

<!-- ✅ Step 4: 付款方式 -->
<div class="section" id="paymentCard">
  <h2 class="section-title">付款方式</h2>

  <div class="payment-options">
    <label class="payment-radio">
      <input type="radio" name="payment" value="cod" checked>
      <span>貨到付款</span>
    </label>

    <label class="payment-radio">
      <input type="radio" name="payment" value="online">
      <span>線上支付</span>
    </label>
  </div>

  <!-- ✅ 線上支付展開選項 -->
  <div id="onlineMethods" class="online-methods">
    <button class="pay-btn" data-method="credit">💳 信用卡</button>
    <button class="pay-btn apple-pay" data-method="applepay" style="display:none;"> Apple Pay</button>
    <button class="pay-btn" data-method="atm">🏧 網路 ATM</button>
  </div>
</div>


<!-- ✅ 同頁：隱私同意 -->
<div class="consent-row">
  <label class="sp-toggle">
    <input type="checkbox" id="consentAgree" />
    <span class="sp-toggle-slider"></span>
    <div class="sp-toggle-text">
      <span class="sp-toggle-label">我同意提供聯絡資訊用於出貨通知與售後服務</span>
      <span class="sp-consent-note">我們僅會使用您的資料於出貨通知、售後服務，不另作行銷用途。</span>
    </div>
  </label>
</div>

<!-- ✅ 送出訂單按鈕 -->
<div class="submit-area">
  <button id="submitOrderBtn" class="btn btn-primary" type="button" disabled>
    送出訂單
  </button>
</div>



  <!-- ✅ 同頁：超商門市選擇器 Bottom Sheet -->
<div id="store-picker" aria-hidden="true">
  <div class="sp-backdrop" data-sp-close></div>
  <section class="sp-sheet" role="dialog" aria-modal="true">
    <div class="sp-handle"></div>

    <header class="sp-header">
      <h3 id="sp-title">選擇取貨門市</h3>
      <button class="sp-close" type="button" title="關閉" data-sp-close>✕</button>
    </header>

    <div class="sp-toolbar">
      <select id="sp-brand" class="sp-select sp-brand">
        <option value="all">全部品牌</option>
        <option value="7-11">7-ELEVEN</option>
        <option value="familymart">全家 FamilyMart</option>
      </select>
      <input id="sp-q" class="sp-input sp-query" type="search" placeholder="輸入地標或地址">
      <button id="sp-search-btn" class="sp-search-title" type="button">搜尋</button>
    </div>

    <div id="sp-map" class="sp-map" aria-label="地圖"></div>
    <div class="sp-scroll">
      <div id="sp-results" class="sp-results"></div>
    </div>
  </section>
</div>


 

  <!-- ✅ 固定結帳工具列 -->
<div class="stickybar glassy" id="StickyBar">
  <div class="sticky-inner">
    <div class="stack amounts">
      <div class="grand">
        應付總額：<b id="total_s">NT$ 0</b>
      </div>

      <div id="stickySubDetail" class="">
        <div class="subline">
          小計 <span id="sub_s">—</span>
          <span id="disc_wrap"> ・ 折扣 <span id="disc_s">—</span></span>
          ・ 運費 <span id="ship_s">—</span>
        </div>

        <div id="freeProgress" class="progress-bar-wrap hidden">
          <div id="freeProgressBar"></div>
        </div>
        <span id="free_tip_s" class="muted"></span>
      </div>
    </div>

    <button id="viewCartBtn" class="btn btn-outline" type="button">查看明細 ▾</button>
  </div>
</div>


<!-- ✅ 購物明細 Bottom Sheet -->
<div id="cartSheetBackdrop" class="sheet-backdrop" aria-hidden="true">
  <div id="cartSheet" class="sheet" data-open="false">
    <div class="sheet-handle"></div>
    <h3>購物明細</h3>
    <div id="cartItems"></div>
    <div class="line"><span>小計</span><b id="cartSub">—</b></div>
    <div class="line" id="cartDiscRow"><span>折扣</span><b id="cartDisc">—</b></div>
    <div class="line"><span>運費</span><b id="cartShip">—</b></div>
    <div class="line total"><span>應付總額</span><b id="cartTotal">—</b></div>
    <div id="promoMsg" class="muted" style="margin-top:8px;"></div>
    <button id="closeCartModal" class="btn btn-outline">關閉</button>
  </div>
</div>

<!-- ✅ 成功卡片 -->
<div id="successBackdrop" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="successTitle">
    <div class="success-icon">✓</div>
    <h2 id="successTitle" class="big">訂單已送出</h2>
    <p id="successDetail" class="muted">感謝您的訂購，我們將儘快為您出貨。</p>

    <div class="order-summary">
      <div class="summary-item">
        <span class="label">訂單編號</span>
        <span id="successOrderId" class="value"></span>
      </div>
      <div class="summary-item">
        <span class="label">金額</span>
        <span id="successTotal" class="value"></span>
      </div>
    </div>

    <div class="line-bind-box" id="lineBindBox" hidden>
      <div class="line-bind-title">LINE 通知綁定</div>
      <div class="line-bind-text">點擊下方按鈕即可追蹤訂單進度與出貨狀態。</div>
      <a id="lineBindBtn" class="line-bind-btn" target="_blank">🔗 前往 LINE 綁定</a>
      <div class="line-bind-note">若尚未加好友，系統會先跳出加好友畫面。</div>
    </div>

    <div class="ok">
      <button id="successClose" class="btn btn-primary" type="button">回到表單</button>
    </div>
  </div>
</div>

<!-- ✅ 全螢幕 Loading 動畫 -->
<div id="globalLoading" class="loading-overlay hidden" aria-hidden="true">
  <div class="loading-spinner"></div>
  <div class="loading-text">正在送出訂單…</div>
</div>


    <!-- 主 JS（指向 /api/*） -->
  <script type="module" src="assets/js/app.js"></script>
</body>
</html>
